<!DOCTYPE html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>3D Maze</title><style>body{margin:0;overflow:hidden;background:#000;font-family:sans-serif;color:#fff}canvas{display:block}#b{position:absolute!important;top:0!important;left:0!important;width:100%!important;height:100%!important;background:rgba(0,0,0,.8)!important;display:flex!important;justify-content:center!important;align-items:center!important;flex-direction:column!important;z-index:20!important}#gt{font-size:3em;margin-bottom:20px;color:#eee;text-shadow:2px 2px #000}#i{text-align:center;padding:20px;border:1px solid #555;border-radius:5px;background:rgba(0,0,0,.9)}#i p{margin-bottom:10px;font-size:1.1em}#i button{font-size:18px;padding:10px 20px;cursor:pointer;background:#4CAF50;color:#fff;border:0;border-radius:5px;transition:background .3s ease}#i button:hover{background:#45a049}#mc{position:fixed!important;top:10px!important;left:10px!important;border:2px solid #fff;background:rgba(0,0,0,.8)!important;z-index:10!important;width:150px!important;height:150px!important;border-radius:5px}#h{position:fixed!important;top:10px!important;right:10px!important;background:rgba(0,0,0,.8)!important;color:#eee!important;padding:10px!important;border:1px solid #555!important;border-radius:5px;z-index:10!important;font-size:1em}#h p{margin:5px 0}#ws,#gos{position:fixed!important;top:0!important;left:0!important;width:100%!important;height:100%!important;background:rgba(0,0,0,.9)!important;display:none!important;justify-content:center!important;align-items:center!important;flex-direction:column!important;z-index:30!important}#ws h2,#gos h2{font-size:3em;color:#fff;text-shadow:2px 2px #000;margin-bottom:20px}#ws button,#gos button{font-size:18px;padding:10px 20px;cursor:pointer;background:#008CBA;color:#fff;border:0;border-radius:5px;transition:background .3s ease}#ws button:hover,#gos button:hover{background:#0077b3}</style><script src=https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js></script><script src=https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/PointerLockControls.js></script></head><body><div id=b><div id=i><div id=gt>3D Maze</div><p><b>WASD/Arrows</b>:Move. Mouse:Look. Click:Start/Shoot.<button id=sb>Enter</button></div></div><canvas id=mc></canvas><div id=h><p>Status: Exploring</p></div><div id=ws><h2>Win!</h2><button id=rw>Again?</button></div><div id=gos><h2>Lost!</h2><button id=rgo>Retry?</button></div><script>let MW=15,MH=15,WH=2,WT=1,PH=1.6,PR=.3,PMS=20,PD=10,PS=15,PRAD=.05,PLDSQ=900,ES=.04,ER=.4,EH=1.5,CM=.1,PT=15,ERT=3e3,HDT=ER+PRAD+.2,ESW=!0,FC=2236962,FN=1,FF=30,SC=1500,SAS=MW*1.5,SH=15,SS=-.05,LP=.001,cam,scn,ren,ctrl,enmy,walls=[],wBB=[],projs=[],move={f:!1,b:!1,l:!1,r:!1},vel=new THREE.Vector3,dir=new THREE.Vector3,clk=new THREE.Clock,genMze,ePath=[],pIdx=0,pCnt=0,eCube,blkr,inst,sBtn,tLdr=new THREE.TextureLoader,cTLdr=new THREE.CubeTextureLoader,sParts,pLFlicker,bCamY=PH,lTOut=null,dAmbInt,dDirInt,skyBTex=null,hLight,dLight,mMCanvas,mMCtx,wGeo,fGeo,eGeo,pGeo,sGeo,wMat,fMat,eMat,pMat,sMat,hud,wsEl,gosEl;function init(){blkr=document.getElementById('b');inst=document.getElementById('i');sBtn=document.getElementById('sb');hud=document.getElementById('h');wsEl=document.getElementById('ws');gosEl=document.getElementById('gos');wGeo=new THREE.BoxGeometry(WT,WH,WT);fGeo=new THREE.PlaneGeometry(MW,MH);eGeo=new THREE.BoxGeometry(ER*2,EH,ER*2);pGeo=new THREE.SphereGeometry(PRAD,8,8);scn=new THREE.Scene;scn.fog=new THREE.Fog(FC,FN,FF);scn.background=new THREE.Color(FC);cam=new THREE.PerspectiveCamera(75,innerWidth/innerHeight,.1,1e3);cam.position.y=bCamY;ren=new THREE.WebGLRenderer({antialias:!0});ren.setSize(innerWidth,innerHeight);ren.setPixelRatio(devicePixelRatio);if(ESW){ren.shadowMap.enabled=!0;ren.shadowMap.type=THREE.PCFSoftShadowMap}document.body.appendChild(ren.domElement);sky();stCt();ldAs();stLt();genMBuild();spEn();stWth();stMM();stEvL();anim()}function sky(){const p='https://threejs.org/examples/textures/cube/Park3Med/',f='.jpg',u=[p+'px'+f,p+'nx'+f,p+'py'+f,p+'ny'+f,p+'pz'+f,p+'nz'+f];try{cTLdr.load(u,t=>{scn.background=t;skyBTex=t},void 0,e=>{console.error("Skybox fail:",e);if(!scn.background)scn.background=new THREE.Color(FC)})}catch(e){console.error("Skybox init fail:",e);if(!scn.background)scn.background=new THREE.Color(FC)}}function stCt(){ctrl=new THREE.PointerLockControls(cam,document.body);scn.add(ctrl.getObject())}function ldAs(){const fbC=11184810;wMat=new THREE.MeshStandardMaterial({map:tLdr.load('https://threejs.org/examples/textures/brick_diffuse.jpg',void 0,void 0,()=>wMat.color.setHex(fbC))});if(wMat.map)wMat.map.wrapS=wMat.map.wrapT=THREE.RepeatWrapping;fMat=new THREE.MeshStandardMaterial({map:tLdr.load('https://threejs.org/examples/textures/hardwood2_diffuse.jpg',void 0,void 0,()=>fMat.color.setHex(fbC)),side:THREE.DoubleSide});if(fMat.map){fMat.map.wrapS=fMat.map.wrapT=THREE.RepeatWrapping;fMat.map.repeat.set(MW/2,MH/2)}eMat=new THREE.MeshStandardMaterial({color:16711680,roughness:.8});pMat=new THREE.MeshBasicMaterial({color:16777215});const sTex=tLdr.load('https://threejs.org/examples/textures/sprites/snowflake4.png',void 0,void 0,err=>console.warn("Snowflake texture fail."));sMat=new THREE.PointsMaterial({color:16777215,size:.2,map:sTex,blending:THREE.AdditiveBlending,depthWrite:!1,transparent:!0,opacity:.7})}function stLt(){const skyC=3355443,grndC=2236962;dAmbInt=.2;hLight=new THREE.HemisphereLight(skyC,grndC,dAmbInt);scn.add(hLight);dDirInt=ESW?.1:.2;dLight=new THREE.DirectionalLight(16777215,dDirInt);dLight.position.set(15,30,20);if(ESW){dLight.castShadow=!0;dLight.shadow.mapSize.width=1024;dLight.shadow.mapSize.height=1024;const sCS=MW;dLight.shadow.camera.left=-sCS;dLight.shadow.camera.right=sCS;dLight.shadow.camera.top=sCS;dLight.shadow.camera.bottom=-sCS;dLight.shadow.camera.near=.5;dLight.shadow.camera.far=50;dLight.shadow.bias=-.001}scn.add(dLight);pLFlicker=new THREE.PointLight(16777215,.4,15);pLFlicker.position.set(MW*.2,WH*.6,-MH*.2);scn.add(pLFlicker);const pL2=new THREE.PointLight(8388608,.3,12);pL2.position.set(MW*.8,WH*.75,-MH*.8);scn.add(pL2)}function stWth(){sGeo=new THREE.BufferGeometry;const v=[];const sRX=SAS/2,sRZ=SAS/2;for(let i=0;i<SC;i++){const x=Math.random()*SAS-sRX,y=Math.random()*SH,z=Math.random()*SAS-sRZ;v.push(x,y,z)}sGeo.setAttribute('position',new THREE.Float32BufferAttribute(v,3));sParts=new THREE.Points(sGeo,sMat);sParts.position.set((MW-1)/2,0,-(MH-1)/2);sMat.color.set(11184810);sMat.size=.25;scn.add(sParts)}function genMBuild(){genMze=genPrcMz(MW,MH);walls=[];wBB=[];if(eCube)scn.remove(eCube);let ePos=null;for(let r=0;r<MH;r++){for(let c=0;c<MW;c++){if(genMze[r][c]===1){const w=new THREE.Mesh(wGeo,wMat);w.position.set(c,WH/2,-r);if(ESW){w.castShadow=!0;w.receiveShadow=!0}scn.add(w);walls.push(w);wBB.push((new THREE.Box3).setFromObject(w).expandByScalar(-CM*.5))}else if(genMze[r][c]===2){const exG=new THREE.BoxGeometry(WT*.8,WH*.8,WT*.8),exM=new THREE.MeshStandardMaterial({color:65280,emissive:65280,emissiveIntensity:.5});eCube=new THREE.Mesh(exG,exM);eCube.position.set(c,WH/2,-r);if(ESW){eCube.castShadow=!0;eCube.receiveShadow=!0}scn.add(eCube);ePos=new THREE.Vector3(c,bCamY,-r);window.eCube=eCube}}}ctrl.getObject().position.set(1,bCamY,-1);const flr=new THREE.Mesh(fGeo,fMat);flr.rotation.x=-Math.PI/2;flr.position.set((MW-1)/2,0,-(MH-1)/2);if(ESW)flr.receiveShadow=!0;scn.add(flr);window.ePos=ePos}function spEn(){let sPos=null,att=0;while(!sPos&&att<MW*MH){const r=Math.floor(Math.random()*MH),c=Math.floor(Math.random()*MW);if(genMze&&genMze[r]&&genMze[r][c]===0)sPos=new THREE.Vector3(c,EH/2,-r);att++}if(!sPos){console.warn("Enemy spawn fail.");sPos=new THREE.Vector3(MW-2,EH/2,-(MH-2))}if(!enmy){enmy=new THREE.Mesh(eGeo,eMat);if(ESW)enmy.castShadow=!0;scn.add(enmy)}enmy.position.copy(sPos);enmy.baseY=sPos.y;enmy.visible=!0;pIdx=0;ePath=[]}function shoot(){if(ctrl.isLocked){const p=new THREE.Mesh(pGeo,pMat);p.position.copy(cam.position);p.velocity=new THREE.Vector3;ctrl.getDirection(p.velocity);p.velocity.multiplyScalar(PS);p.tdSq=0;scn.add(p);projs.push(p)}}function getPN(n,m){const N=[];const{r,c}=n;const M=[{dr:-1,dc:0},{dr:1,dc:0},{dr:0,dc:-1},{dr:0,dc:1}];for(const mv of M){const nr=r+mv.dr,nc=c+mv.dc;if(nr>=0&&nr<MH&&nc>=0&&nc<MW&&m[nr][nc]===0)N.push({r:nr,c:nc})}return N}const heur=(a,b)=>Math.abs(a.r-b.r)+Math.abs(a.c-b.c);function findP(stN,enN,m){const oS=[stN],cF=new Map,gS=new Map,fS=new Map,sStr=JSON.stringify(stN);gS.set(sStr,0);fS.set(sStr,heur(stN,enN));while(oS.length>0){let cur=oS.reduce((a,b)=>(fS.get(JSON.stringify(a))||Infinity)<(fS.get(JSON.stringify(b))||Infinity)?a:b);const cStr=JSON.stringify(cur);if(cur.r===enN.r&&cur.c===enN.c)return reconP(cF,cur);oS.splice(oS.indexOf(cur),1);for(const n of getPN(cur,m)){const nStr=JSON.stringify(n),tGS=(gS.get(cStr)||Infinity)+1;if(tGS<(gS.get(nStr)||Infinity)){cF.set(nStr,cur);gS.set(nStr,tGS);fS.set(nStr,tGS+heur(n,enN));if(!oS.some(nd=>nd.r===n.r&&nd.c===n.c))oS.push(n)}}}return null}const reconP=(cF,cur)=>{const p=[cur];let cStr=JSON.stringify(cur);while(cF.has(cStr)){cur=cF.get(cStr);p.unshift(cur);cStr=JSON.stringify(cur)}return p};function upEnAI(d,t){if(!enmy||!enmy.visible||!genMze)return;enmy.position.y=enmy.baseY+Math.sin(t*2)*.05;pCnt++;if(pCnt>=PT){pCnt=0;const pP=ctrl.getObject().position,eGP={r:Math.round(-enmy.position.z),c:Math.round(enmy.position.x)},plGP={r:Math.round(-pP.z),c:Math.round(pP.x)};if(eGP.r>=0&&eGP.r<MH&&eGP.c>=0&&eGP.c<MW&&plGP.r>=0&&plGP.r<MH&&plGP.c>=0&&plGP.c<MW&&genMze[eGP.r][eGP.c]===0&&genMze[plGP.r][plGP.c]===0){ePath=findP(eGP,plGP,genMze);pIdx=0}else ePath=[]}if(ePath&&ePath.length>pIdx){const tGC=ePath[pIdx],tWP=new THREE.Vector3(tGC.c,enmy.position.y,-tGC.r);if(enmy.position.distanceTo(tWP)>.1)enmy.position.lerp(tWP,ES);else pIdx++}}function upWth(d,t){if(!sParts||!sGeo)return;const pos=sGeo.attributes.position.array,pCt=pos.length/3,sRX=SAS/2,sRZ=SAS/2,pP=ctrl.getObject().position;sParts.position.set(pP.x,sParts.position.y,pP.z);for(let i=0;i<pCt;i++){const i3=i*3;pos[i3+1]+=SS*d*60;if(pos[i3+1]<0){pos[i3]=Math.random()*SAS-sRX;pos[i3+1]=SH;pos[i3+2]=Math.random()*SAS-sRZ}}const dSX=Math.sin(t*.1)*.01*d*60,dSZ=Math.cos(t*.15)*.005*d*60;for(let i=0;i<pCt;i++){const i3=i*3;pos[i3]+=dSX;pos[i3+2]+=dSZ}sGeo.attributes.position.needsUpdate=!0}function upProj(d){for(let i=projs.length-1;i>=0;i--){const p=projs[i];p.position.add(p.velocity.clone().multiplyScalar(d));p.tdSq+=p.velocity.lengthSq()*d*d;if(p.tdSq>PLDSQ){scn.remove(p);projs.splice(i,1);continue}const pSph=new THREE.Sphere(p.position,PRAD);let hit=!1;for(const wB of wBB){if(wB.intersectsSphere(pSph)){scn.remove(p);projs.splice(i,1);hit=!0;break}}if(hit)continue;if(enmy&&enmy.visible&&p.position.distanceTo(enmy.position)<HDT){scn.remove(p);projs.splice(i,1);enmy.visible=!1;setTimeout(spEn,ERT);break}}}function chkCol(){const pP=ctrl.getObject().position,pSph=new THREE.Sphere(pP,PR);for(const wB of wBB){if(wB.intersectsSphere(pSph)){const cl=wB.clampPoint(pP,new THREE.Vector3),cN=pP.clone().sub(cl).normalize(),pen=PR-cl.distanceTo(pP);pP.add(cN.multiplyScalar(pen+CM));ctrl.getObject().position.copy(pP);vel.x=0;vel.z=0}}if(enmy&&enmy.visible){const eSph=new THREE.Sphere(enmy.position,ER);if(pSph.intersectsSphere(eSph)){console.log("Lost!");gosEl.style.display='flex';ctrl.unlock()}}if(window.ePos){const wRSq=Math.pow(PR+.5,2);if(pP.distanceToSquared(window.ePos)<wRSq){console.log("Win! New maze.");hud.querySelector('p').textContent='Status: New Maze!';wsEl.style.display='none';MW+=2;MH+=2;genMBuild();ctrl.getObject().position.set(1,bCamY,-1);vel.set(0,0,0);spEn();ctrl.lock()}}}function upMM(){if(!mMCanvas||!mMCtx||!genMze)return;const pP=ctrl.getObject().position,eP=enmy?enmy.position:null,cW=mMCanvas.width,cH=mMCanvas.height,mW=MW,mH=MH,clW=cW/mW,clH=cH/mH;mMCtx.fillStyle='rgba(0,0,0,.7)';mMCtx.fillRect(0,0,cW,cH);for(let r=0;r<mH;r++)for(let c=0;c<mW;c++){if(genMze[r][c]===1){mMCtx.fillStyle='#555';mMCtx.fillRect(c*clW,r*clH,clW,clH)}else if(genMze[r][c]===2){mMCtx.fillStyle='lime';mMCtx.fillRect(c*clW,r*clH,clW,clH)}}const pMX=Math.round(pP.x),pMZ=Math.round(-pP.z);if(pMX>=0&&pMX<mW&&pMZ>=0&&pMZ<mH){mMCtx.fillStyle='yellow';mMCtx.beginPath();const cX=pMX*clW+clW/2,cY=pMZ*clH+clH/2,aSz=Math.min(clW,clH)*.9;let tD=0;if(Math.abs(vel.x)>.01||Math.abs(vel.z)>.01)tD=Math.atan2(-vel.z,vel.x);else tD=cam.rotation.y;const hX=cX+aSz*Math.sin(tD),hY=cY-aSz*Math.cos(tD),tLX=cX+aSz*.6*Math.sin(tD+Math.PI*.7),tLY=cY-aSz*.6*Math.cos(tD+Math.PI*.7),tRX=cX+aSz*.6*Math.sin(tD-Math.PI*.7),tRY=cY-aSz*.6*Math.cos(tD-Math.PI*.7);mMCtx.moveTo(hX,hY);mMCtx.lineTo(tLX,tLY);mMCtx.lineTo(tRX,tRY);mMCtx.closePath();mMCtx.fill()}if(eP&&enmy&&enmy.visible){const eMX=Math.floor(eP.x),eMZ=Math.floor(-eP.z);if(eMX>=0&&eMX<mW&&eMZ>=0&&eMZ<mH){mMCtx.fillStyle='red';mMCtx.fillRect(eMX*clW+clW*.25,eMZ*clH+clH*.25,clW*.5,clH*.5)}}}function upLt(d,t){if(lTOut)return;if(Math.random()<LP){const oBg=scn.background;scn.background=new THREE.Color(16777215);scn.fog.color.set(16777215);if(hLight)hLight.intensity=1;if(dLight)dLight.intensity=2;lTOut=setTimeout(()=>{scn.background=oBg;scn.fog.color.set(FC);if(hLight)hLight.intensity=dAmbInt;if(dLight)dLight.intensity=dDirInt;lTOut=null},100+Math.random()*200)}}function upFlL(t){if(pLFlicker)pLFlicker.intensity=.4+Math.sin(t*5)*.1}function anim(){requestAnimationFrame(anim);const d=clk.getDelta(),t=clk.getElapsedTime();if(ctrl.isLocked){vel.x-=vel.x*PD*d;vel.z-=vel.z*PD*d;dir.z=Number(move.f)-Number(move.b);dir.x=Number(move.r)-Number(move.l);dir.normalize();if(move.f||move.b)vel.z-=dir.z*PMS*d;if(move.l||move.r)vel.x-=dir.x*PMS*d;ctrl.moveRight(-vel.x*d);ctrl.moveForward(-vel.z*d);chkCol();upEnAI(d,t);upProj(d);upWth(d,t);upLt(d,t);upFlL(t);const isM=Math.abs(vel.x)>.01||Math.abs(vel.z)>.01;cam.position.y=bCamY+(isM?Math.sin(t*10)*.05:0)}upMM();ren.render(scn,cam)}function stEvL(){document.addEventListener('keydown',e=>{switch(e.code){case'ArrowUp':case'KeyW':move.f=!0;break;case'ArrowLeft':case'KeyA':move.l=!0;break;case'ArrowDown':case'KeyS':move.b=!0;break;case'ArrowRight':case'KeyD':move.r=!0;break}});document.addEventListener('keyup',e=>{switch(e.code){case'ArrowUp':case'KeyW':move.f=!1;break;case'ArrowLeft':case'KeyA':move.l=!1;break;case'ArrowDown':case'KeyS':move.b=!1;break;case'ArrowRight':case'KeyD':move.r=!1;break}});document.addEventListener('click',()=>{if(!ctrl.isLocked)ctrl.lock();else shoot()});ctrl.addEventListener('lock',()=>{inst.style.display='none';blkr.style.display='none';if(!clk.running)clk.start()});ctrl.addEventListener('unlock',()=>{blkr.style.display='flex';inst.style.display='';if(clk.running)clk.stop();move={f:!1,b:!1,l:!1,r:!1}});sBtn.addEventListener('click',e=>{e.stopPropagation();ctrl.lock()});addEventListener('resize',()=>{cam.aspect=innerWidth/innerHeight;cam.updateProjectionMatrix();ren.setSize(innerWidth,innerHeight)});document.getElementById('rw')?.addEventListener('click',()=>location.reload());document.getElementById('rgo')?.addEventListener('click',()=>location.reload())}function stMM(){mMCanvas=document.getElementById('mc');if(mMCanvas){mMCtx=mMCanvas.getContext('2d');mMCanvas.width=150;mMCanvas.height=150}else console.error("Minimap canvas not found!")}function genPrcMz(w,h){const m=Array(h).fill(null).map(()=>Array(w).fill(1)),s=[[1,1]];m[1][1]=0;while(s.length>0){const[r,c]=s[s.length-1],n=[];const D=[[-2,0],[2,0],[0,-2],[0,2]].sort(()=>Math.random()-.5);for(const[dr,dc]of D){const nr=r+dr,nc=c+dc;if(nr>0&&nr<h-1&&nc>0&&nc<w-1&&m[nr][nc]===1)n.push([nr,nc,(r+nr)/2,(c+nc)/2])}if(n.length>0){const[nR,nC,wR,wC]=n[0];m[wR][wC]=0;m[nR][nC]=0;s.push([nR,nC])}else s.pop()}let eR=h-2,eC=w-2;if(m[eR][eC]!==0){for(let r=h-2;r>=1;r--){for(let c=w-2;c>=1;c--){if(m[r][c]===0){eR=r;eC=c;break}}if(m[eR][eC]===0)break}}m[eR][eC]=2;return m}init();
</script></body></html>